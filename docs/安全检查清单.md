# ONote 安全检查清单

本文档提供了 ONote 应用开发和部署的安全检查清单，确保应用符合安全最佳实践。

---

## 开发阶段

### 代码安全

- [ ] **不硬编码敏感信息**
  ```typescript
  // ❌ 错误
  const apiKey = 'sk-xxxxxxxxxxxxx';

  // ✅ 正确
  const apiKey = process.env.API_KEY;
  ```

- [ ] **使用 TypeScript 严格模式**
  ```json
  {
    "compilerOptions": {
      "strict": true,
      "noImplicitAny": true
    }
  }
  ```

- [ ] **验证所有用户输入**
  ```typescript
  // ✅ 验证文件路径
  function validatePath(path: string): boolean {
    // 防止路径遍历攻击
    return !path.includes('..');
  }
  ```

- [ ] **避免使用 `any` 类型**
  ```typescript
  // ❌ 错误
  function processData(data: any) { }

  // ✅ 正确
  function processData(data: unknown) {
    if (isValidData(data)) {
      // 处理数据
    }
  }
  ```

### 依赖安全

- [ ] **定期运行 `yarn audit`**
  ```bash
  yarn audit
  ```

- [ ] **使用 `yarn outdated` 检查更新**
  ```bash
  yarn outdated
  ```

- [ ] **锁住关键依赖版本**
  ```bash
  yarn add package@version --exact
  ```

- [ ] **审查新添加的依赖**
  - 检查维护状态
  - 查看安全记录
  - 评估依赖数量

### IPC 通信安全

- [ ] **验证 IPC 调用参数**
  ```typescript
  // ✅ 主进程验证
  class FileHandler {
    async readFile(event, path: string) {
      if (!isValidPath(path)) {
        throw new Error('Invalid path');
      }
      return await fs.readFile(path);
    }
  }
  ```

- [ ] **限制 IPC 命名空间访问**
  ```typescript
  // 只注册必要的 handler
  ipcServer.register(IPCNamespaces.DataSource, DataSourceHandler);
  ```

- [ ] **使用 Context Isolation**
  ```typescript
  // preload.ts
  contextBridge.exposeInMainWorld('api', {
    invoke: (channel, ...args) => ipcRenderer.invoke(channel, ...args)
  });
  ```

### 文件系统安全

- [ ] **限制文件访问范围**
  ```typescript
  // ✅ 限制在笔记目录
  const NOTE_DIR = process.env.DEFAULT_NOTE_DIR;

  function isAllowedPath(path: string): boolean {
    return path.startsWith(NOTE_DIR);
  }
  ```

- [ ] **验证文件类型**
  ```typescript
  // 只允许特定文件类型
  const ALLOWED_EXTENSIONS = ['.md', '.txt', '.json'];

  function isAllowedFile(filename: string): boolean {
    return ALLOWED_EXTENSIONS.some(ext => filename.endsWith(ext));
  }
  ```

- [ ] **防止路径遍历**
  ```typescript
  // ✅ 规范化路径
  import { normalize, resolve } from 'path';

  function safePath(userPath: string): string {
    const normalized = normalize(userPath);
    const resolved = resolve(NOTE_DIR, normalized);
    if (!resolved.startsWith(NOTE_DIR)) {
      throw new Error('Path traversal detected');
    }
    return resolved;
  }
  ```

---

## 构建阶段

### 生产配置

- [ ] **启用生产模式**
  ```typescript
  // webpack.config.js
  mode: 'production',
  ```

- [ ] **移除调试代码**
  ```typescript
  // ❌ 生产代码中不应该有
  console.log('Debug info');
  debugger;

  // ✅ 使用条件日志
  if (process.env.NODE_ENV === 'development') {
    console.log('Debug info');
  }
  ```

- [ ] **启用代码压缩**
  ```javascript
  // webpack.config.js
  optimization: {
    minimize: true,
  }
  ```

- [ ] **生成 Source Maps（可选）**
  ```javascript
  // 生产环境可以使用 external source map
  devtool: 'hidden-source-map'
  ```

### 环境变量

- [ ] **使用 .env 文件**
  ```bash
  # .env
  API_KEY=your-production-key
  ```

- [ ] **不提交 .env 到版本控制**
  ```gitignore
  # .gitignore
  .env
  .env.local
  .env.*.local
  ```

- [ ] **提供 .env.example**
  ```bash
  # .env.example
  API_KEY=your-api-key-here
  ```

---

## 部署阶段

### Electron 安全

- [ ] **禁用 Node.js 集成（渲染进程）**
  ```typescript
  // BrowserWindow 构造函数
  new BrowserWindow({
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js')
    }
  });
  ```

- [ ] **启用 Context Isolation**
  ```typescript
  webPreferences: {
    contextIsolation: true,
  }
  ```

- [ ] **设置 CSP (Content Security Policy)**
  ```typescript
  session.defaultSession.webRequest.onHeadersReceived((details, callback) => {
    callback({
      responseHeaders: {
        ...details.responseHeaders,
        'Content-Security-Policy': [
          "default-src 'self';",
          "script-src 'self';",
          "style-src 'self' 'unsafe-inline';",
          "img-src 'self' data: https:;",
          "font-src 'self' data:;",
          "connect-src 'self' https://api.openai.com;"
        ]
      }
    });
  });
  ```

- [ ] **限制远程资源加载**
  ```typescript
  // 只允许加载特定协议
  app.on('web-contents-created', (event, contents) => {
    contents.on('will-navigate', (event, navigationUrl) => {
      const parsedUrl = new URL(navigationUrl);
      if (parsedUrl.protocol !== 'file:' && parsedUrl.protocol !== 'onote:') {
        event.preventDefault();
      }
    });
  });
  ```

### 数据保护

- [ ] **加密敏感数据**
  ```typescript
  import { safeStorage } from 'electron';

  // 加密密码
  const encryptedPassword = safeStorage.encryptString('my-password');

  // 解密密码
  const password = safeStorage.decryptString(encryptedPassword);
  ```

- [ ] **使用安全存储**
  ```typescript
  // 使用 electron-store 存储加密配置
  const store = new Store({
    name: 'config',
    encryptionKey: 'your-encryption-key'
  });
  ```

- [ ] **清理敏感数据**
  ```typescript
  // 应用退出时清理
  app.on('will-quit', () => {
    // 清除内存中的敏感数据
    clearSensitiveData();
  });
  ```

### 更新安全

- [ ] **验证更新签名**
  ```typescript
  // electron-updater 配置
  autoUpdater.setFeedURL({
    provider: 'github',
    owner: 'your-org',
    repo: 'ONote',
    // 私有应用需要配置 token
  });
  ```

- [ ] **使用 HTTPS 更新**
  ```typescript
  // 确保更新服务器使用 HTTPS
  autoUpdater.setFeedURL('https://updates.example.com');
  ```

---

## 运行时安全

### 日志管理

- [ ] **不记录敏感信息**
  ```typescript
  // ❌ 错误
  console.log('User password:', password);

  // ✅ 正确
  console.log('User authentication attempted');
  ```

- [ ] **使用日志级别**
  ```typescript
  // 根据环境设置日志级别
  const logLevel = process.env.NODE_ENV === 'production' ? 'warn' : 'debug';
  ```

- [ ] **定期清理日志**
  ```typescript
  // 实现日志轮转
  const maxLogAge = 7 * 24 * 60 * 60 * 1000; // 7 天
  cleanOldLogs(maxLogAge);
  ```

### 错误处理

- [ ] **捕获所有错误**
  ```typescript
  // 渲染进程错误边界
  <ErrorBoundary
    onError={(error) => {
      // 上报错误，但不泄露敏感信息
      reportError({
        message: error.message,
        stack: error.stack,
        // 不包含用户数据
      });
    }}
  >
    <App />
  </ErrorBoundary>
  ```

- [ ] **优雅降级**
  ```typescript
  // 功能失败时不崩溃
  async function loadFeature() {
    try {
      return await feature.load();
    } catch (error) {
      console.error('Feature failed to load:', error);
      return null; // 返回备用值
    }
  }
  ```

### 权限控制

- [ ] **最小权限原则**
  ```typescript
  // 只请求必要的权限
  const permissions = [
    'fs:read',  // 只读
    // 不需要 fs:write
  ];
  ```

- [ ] **用户授权**
  ```typescript
  // 敏感操作需要用户确认
  async function deleteFile(fileId: string) {
    const confirmed = await dialog.showMessageBox({
      message: '确定要删除此文件吗？',
      buttons: ['取消', '删除']
    });

    if (confirmed.response === 1) {
      await fs.unlink(fileId);
    }
  }
  ```

---

## 定期审查

### 每周检查

- [ ] 运行 `yarn audit`
- [ ] 检查 Dependabot alerts
- [ ] 审查最近的依赖更新

### 每月检查

- [ ] 运行 `yarn outdated`
- [ ] 更新关键依赖
- [ ] 审查安全日志
- [ ] 检查 Electron 安全公告

### 每季度检查

- [ ] 全面安全审计
- [ ] 渗透测试
- [ ] 代码安全审查
- [ ] 更新安全文档

---

## 自动化安全

### CI/CD 集成

- [ ] **自动化安全扫描**
  ```yaml
  # .github/workflows/security.yml
  name: Security Scan
  on: [push, pull_request]
  jobs:
    security:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Run audit
          run: yarn audit
        - name: Check for vulnerabilities
          uses: securecodewarrior/github-action-add-sarif@v0.1.1
  ```

- [ ] **依赖自动更新**
  ```json
  // renovate.json
  {
    "extends": ["config:base"],
    "vulnerabilityAlerts": {
      "labels": ["security"],
      "assignees": ["@security-team"]
    }
  }
  ```

---

## 事件响应

### 安全事件处理流程

1. **发现**
   - 监控安全日志
   - 用户报告
   - 自动化警报

2. **评估**
   - 确定影响范围
   - 评估严重程度
   - 分类事件类型

3. **响应**
   - 启动应急响应
   - 修复漏洞
   - 通知用户（如需要）

4. **恢复**
   - 验证修复
   - 恢复服务
   - 监控后续

5. **复盘**
   - 分析根因
   - 改进流程
   - 更新文档

---

## 资源和参考

### 安全资源

- [Electron Security Checklist](https://www.electronjs.org/docs/tutorial/security)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)
- [npm Security](https://docs.npmjs.com/cli/audit)

### 工具

- `yarn audit` - 依赖漏洞扫描
- `npm-check-updates` - 依赖更新检查
- `snyk` - 安全测试平台
- `sonarqube` - 代码质量分析

---

## 联系方式

发现安全问题请联系：
- **Email**: security@onote.example.com
- **PGP Key**: [链接到公钥]

---

**版本**: 1.0
**最后更新**: 2025-01-04
