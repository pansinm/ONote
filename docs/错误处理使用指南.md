# ONote 错误处理系统使用指南

## 概述

ONote 使用统一的错误处理系统，提供标准化的错误类型、错误处理服务和 React 错误边界，提升应用的稳定性和用户体验。

---

## 快速开始

### 1. 使用标准错误类型

```typescript
import { FileError, ErrorCode } from 'shared/errors';

// 抛出文件错误
throw new FileError(
  '文件读取失败',
  ErrorCode.FILE_READ_FAILED,
  filePath,
  originalError,
);
```

### 2. 处理异步错误

```typescript
import { wrapError } from 'shared/errors';

try {
  await riskyOperation();
} catch (error) {
  const appError = wrapError(error, '操作失败');
  logger.error('Operation failed', appError);
}
```

### 3. 使用错误边界

```tsx
import ErrorBoundary from '@/components/ErrorBoundary';

function MyComponent() {
  return (
    <ErrorBoundary
      onError={(error) => {
        logger.error('Component error', error);
      }}
    >
      <YourComponent />
    </ErrorBoundary>
  );
}
```

---

## 错误类型

### 基础错误类

#### `AppError`

所有应用错误的基类。

```typescript
import { AppError, ErrorCode, ErrorSeverity } from 'shared/errors';

const error = new AppError(
  '操作失败',              // 错误消息
  ErrorCode.OPERATION_FAILED,  // 错误码
  ErrorSeverity.MEDIUM,   // 严重级别
  { userId: 123 },        // 上下文信息
  originalError,          // 原始错误（可选）
);
```

#### 特定错误类型

##### `FileError` - 文件操作错误

```typescript
import { FileError, ErrorCode } from 'shared/errors';

throw new FileError(
  '文件不存在',
  ErrorCode.FILE_NOT_FOUND,
  '/path/to/file.txt',
);
```

##### `DataSourceError` - 数据源错误

```typescript
import { DataSourceError, ErrorCode } from 'shared/errors';

throw new DataSourceError(
  '连接失败',
  ErrorCode.DATASOURCE_CONNECTION_FAILED,
  'Gitee',
);
```

##### `PluginError` - 插件错误

```typescript
import { PluginError, ErrorCode } from 'shared/errors';

throw new PluginError(
  '插件加载失败',
  ErrorCode.PLUGIN_LOAD_FAILED,
  'my-plugin',
);
```

##### `NetworkError` - 网络错误

```typescript
import { NetworkError } from 'shared/errors';

throw new NetworkError(
  '网络请求失败',
  'https://api.example.com',
  originalError,
);
```

##### `LLMError` - LLM API 错误

```typescript
import { LLMError, ErrorCode } from 'shared/errors';

throw new LLMError(
  'API 配额超限',
  ErrorCode.LLM_QUOTA_EXCEEDED,
  'OpenAI',
);
```

##### `ConfigError` - 配置错误

```typescript
import { ConfigError } from 'shared/errors';

throw new ConfigError(
  '配置项格式错误',
  'editor.theme',
);
```

---

## 错误码

### 错误码分类

| 错误码范围 | 分类 | 说明 |
|-----------|------|------|
| 1xxx | 通用错误 | 未知错误、网络错误、超时等 |
| 2xxx | 文件操作错误 | 文件读写、删除等操作错误 |
| 3xxx | 数据源错误 | 数据源连接、同步等错误 |
| 4xxx | 插件错误 | 插件加载、版本兼容等错误 |
| 5xxx | 编辑器错误 | 编辑器操作、保存等错误 |
| 6xxx | LLM 错误 | AI 助手 API 相关错误 |
| 7xxx | 配置错误 | 配置项、环境变量等错误 |

### 常用错误码

```typescript
enum ErrorCode {
  // 通用
  UNKNOWN = 1000,
  NETWORK_ERROR = 1001,
  TIMEOUT = 1002,
  INVALID_PARAMS = 1003,

  // 文件
  FILE_NOT_FOUND = 2001,
  FILE_READ_FAILED = 2002,
  FILE_WRITE_FAILED = 2003,

  // 数据源
  DATASOURCE_CONNECTION_FAILED = 3002,
  DATASOURCE_AUTH_FAILED = 3003,

  // 插件
  PLUGIN_LOAD_FAILED = 4002,
  PLUGIN_INVALID = 4003,

  // LLM
  LLM_API_ERROR = 6001,
  LLM_QUOTA_EXCEEDED = 6003,
}
```

---

## 错误严重级别

```typescript
enum ErrorSeverity {
  LOW = 'low',          // 低 - 不影响核心功能
  MEDIUM = 'medium',    // 中 - 影响部分功能
  HIGH = 'high',        // 高 - 影响核心功能
  CRITICAL = 'critical', // 严重 - 应用无法使用
}
```

---

## 错误处理服务

### 主进程错误处理

#### 自动处理

主进程会自动捕获以下错误：

1. **未捕获的异常** (`uncaughtException`)
2. **未处理的 Promise rejection** (`unhandledRejection`)
3. **渲染进程崩溃** (`render-process-gone`)
4. **子进程崩溃** (`child-process-gone`)

#### 手动处理

```typescript
import { handleError, ErrorSeverity } from 'shared/errors';

try {
  await riskyOperation();
} catch (error) {
  handleError(error, ErrorSeverity.HIGH);
}
```

#### 错误队列

```typescript
import { getErrorQueue, clearErrorQueue } from 'shared/errors';

// 获取错误队列
const errors = getErrorQueue();

// 清空错误队列
clearErrorQueue();
```

---

## React 错误边界

### 基础用法

```tsx
import ErrorBoundary from '@/components/ErrorBoundary';

function App() {
  return (
    <ErrorBoundary>
      <YourComponent />
    </ErrorBoundary>
  );
}
```

### 自定义 Fallback UI

```tsx
<ErrorBoundary
  fallback={
    <div>出错了，请刷新页面</div>
  }
>
  <YourComponent />
</ErrorBoundary>
```

### 函数式 Fallback

```tsx
<ErrorBoundary
  fallback={(error, retry) => (
    <div>
      <p>错误: {error.message}</p>
      <button onClick={retry}>重试</button>
    </div>
  )}
>
  <YourComponent />
</ErrorBoundary>
```

### 错误回调

```tsx
<ErrorBoundary
  onError={(error, errorInfo) => {
    logger.error('Component error', error, {
      componentStack: errorInfo.componentStack,
    });
  }}
>
  <YourComponent />
</ErrorBoundary>
```

### 高阶组件用法

```tsx
import { withErrorBoundary } from '@/components/ErrorBoundary';

const SafeComponent = withErrorBoundary(MyComponent, {
  fallback: <div>Something went wrong</div>,
  onError: (error) => {
    console.error('Component error:', error);
  },
});
```

### Hook 用法

```tsx
import { useErrorHandler } from '@/components/ErrorBoundary';

function MyComponent() {
  const [error, setError] = useState(null);

  useErrorHandler(error);

  useEffect(() => {
    async function fetchData() {
      try {
        const data = await api.getData();
      } catch (err) {
        setError(err);
      }
    }

    fetchData();
  }, []);

  return <div>...</div>;
}
```

---

## 工具函数

### `wrapError`

包装未知错误为 `AppError`。

```typescript
import { wrapError } from 'shared/errors';

try {
  await riskyOperation();
} catch (error) {
  const appError = wrapError(error, '操作失败');
  // appError: AppError 实例
}
```

### `isErrorCode`

判断是否为特定错误码。

```typescript
import { isErrorCode, ErrorCode } from 'shared/errors';

if (isErrorCode(error, ErrorCode.FILE_NOT_FOUND)) {
  // 处理文件不存在的情况
}
```

### `getErrorSeverity`

获取错误严重级别。

```typescript
import { getErrorSeverity, ErrorSeverity } from 'shared/errors';

const severity = getErrorSeverity(error);
if (severity === ErrorSeverity.HIGH) {
  // 处理高级别错误
}
```

---

## 最佳实践

### 1. 总是使用标准错误类型

```typescript
// ✅ 好
throw new FileError('文件不存在', ErrorCode.FILE_NOT_FOUND, filePath);

// ❌ 差
throw new Error('File not found');
```

### 2. 提供有用的上下文

```typescript
// ✅ 好
throw new FileError(
  '文件读取失败',
  ErrorCode.FILE_READ_FAILED,
  filePath,
  originalError,
);

// ❌ 差
throw new Error('Read failed');
```

### 3. 记录错误日志

```typescript
try {
  await operation();
} catch (error) {
  const appError = wrapError(error);
  logger.error('Operation failed', appError, {
    userId: user.id,
    action: 'save_file',
  });
}
```

### 4. 为用户提供友好的错误消息

```typescript
// ✅ 好 - 显示用户友好的消息
const userMessage = error instanceof AppError
  ? error.getUserMessage()
  : '操作失败，请稍后重试';

showNotification({ type: 'error', message: userMessage });

// ❌ 差 - 直接显示技术性错误消息
showNotification({ type: 'error', message: error.message });
```

### 5. 使用错误边界包裹关键组件

```tsx
<ErrorBoundary>
  <App />
</ErrorBoundary>
```

### 6. 区分错误严重级别

```typescript
const severity = error instanceof AppError
  ? error.severity
  : ErrorSeverity.MEDIUM;

switch (severity) {
  case ErrorSeverity.CRITICAL:
    // 显示严重错误提示
    break;
  case ErrorSeverity.HIGH:
    // 记录日志并提示用户
    break;
  case ErrorSeverity.MEDIUM:
    // 仅记录日志
    break;
  case ErrorSeverity.LOW:
    // 静默处理
    break;
}
```

---

## 错误上报（预留）

错误处理系统预留了错误上报接口，可以在未来配置：

```typescript
// packages/electron/src/services/error-handler.ts
export const errorHandler = new ErrorHandler({
  showErrorDialog: true,
  enableReporting: true,  // 启用错误上报
  reportingUrl: 'https://your-error-reporting-service.com/api/errors',
});
```

---

## 示例

### 完整的错误处理示例

```typescript
import { logger } from 'shared/logger';
import { FileError, ErrorCode, wrapError, handleError } from 'shared/errors';

class FileService {
  async readFile(filePath: string): Promise<string> {
    try {
      const content = await fs.promises.readFile(filePath, 'utf-8');
      logger.info('File read successfully', { filePath });
      return content;
    } catch (error) {
      // 包装为标准错误类型
      const appError = error instanceof FileError
        ? error
        : new FileError(
            '文件读取失败',
            ErrorCode.FILE_READ_FAILED,
            filePath,
            error as Error,
          );

      // 记录错误日志
      logger.error('Failed to read file', appError);

      // 传递给错误处理服务
      handleError(appError);

      // 重新抛出（如果需要）
      throw appError;
    }
  }

  async saveFile(filePath: string, content: string): Promise<void> {
    try {
      await fs.promises.writeFile(filePath, content, 'utf-8');
      logger.info('File saved successfully', { filePath });
    } catch (error) {
      const appError = wrapError(error, '文件保存失败');
      logger.error('Failed to save file', appError);
      handleError(appError);
      throw appError;
    }
  }
}
```

---

## 相关资源

- [packages/shared/src/errors/index.ts](../packages/shared/src/errors/index.ts) - 错误类型定义
- [packages/electron/src/services/error-handler.ts](../packages/electron/src/services/error-handler.ts) - 错误处理服务
- [packages/renderer/src/components/ErrorBoundary.tsx](../packages/renderer/src/components/ErrorBoundary.tsx) - React 错误边界
- [日志系统使用指南.md](./日志系统使用指南.md) - 日志系统文档

---

**版本**: 1.0
**最后更新**: 2025-01-04
