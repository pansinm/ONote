# ONote 日志系统使用指南

## 概述

ONote 使用基于 `electron-log` 的统一日志系统，提供跨进程的日志管理、级别控制、文件记录等功能。

---

## 快速开始

### 1. 导入日志模块

```typescript
// 主进程或渲染进程
import { getLogger } from 'shared/logger';

// 或者使用快捷方式
import logger from 'shared/logger';
```

### 2. 基本使用

```typescript
// 创建带上下文的日志记录器
const logger = getLogger('MyModule');

// 记录不同级别的日志
logger.debug('Debug information', { data: 'value' });
logger.info('Information message');
logger.warn('Warning message');
logger.error('Error occurred', new Error('Details'));

// 或使用快捷方式
import logger from 'shared/logger';

logger.info('Application started');
```

---

## 日志级别

### 级别说明

| 级别 | 用途 | 示例 |
|------|------|------|
| **DEBUG** | 调试信息 | 函数调用、变量值、执行流程 |
| **INFO** | 一般信息 | 应用启动、功能完成、状态变更 |
| **WARN** | 警告信息 | 降级处理、即将废弃的API、异常但可恢复 |
| **ERROR** | 错误信息 | 异常、错误、失败的操作 |

### 级别控制

```typescript
import { configureLogger, LogLevel } from 'shared/logger';

// 设置日志级别为 INFO（不记录 DEBUG）
configureLogger({
  level: LogLevel.INFO,
});

// 生产环境建议
configureLogger({
  level: process.env.NODE_ENV === 'production' ? LogLevel.WARN : LogLevel.DEBUG,
});
```

---

## 高级用法

### 1. 创建子日志记录器

```typescript
// 创建带命名空间的日志记录器
const parentLogger = getLogger('DataService');
const childLogger = parentLogger.createChild('FileHandler');

// 输出: [timestamp] [INFO] [DataService:FileHandler] File loaded
childLogger.info('File loaded');
```

### 2. 记录对象和错误

```typescript
const logger = getLogger('MyModule');

// 记录对象
logger.info('User data', {
  id: 123,
  name: 'John',
  preferences: { theme: 'dark' }
});

// 记录错误
try {
  await riskyOperation();
} catch (error) {
  logger.error('Operation failed', error);
  // 输出包含错误消息和堆栈跟踪
}
```

### 3. 条件日志

```typescript
const logger = getLogger('MyModule');

// 只在 DEBUG 级别记录详细信息
if (process.env.DEBUG) {
  logger.debug('Detailed debug info', complexObject);
}

// 使用日志级别自动过滤
logger.debug('This will only log if level is DEBUG');
```

---

## 配置选项

### 完整配置示例

```typescript
import { initLogger, LogLevel } from 'shared/logger';

// 应用启动时初始化
initLogger({
  level: LogLevel.INFO,
  format: true,
  fileOptions: {
    logPath: '/path/to/logs/app.log',
    maxSize: 10 * 1024 * 1024, // 10MB
    fileLevel: LogLevel.WARN,    // 文件只记录 WARN 以上
  },
});
```

### 配置说明

```typescript
interface LoggerConfig {
  level: LogLevel;          // 最低日志级别
  format?: boolean;         // 是否格式化输出
  fileOptions?: {
    logPath?: string;       // 日志文件路径
    maxSize?: number;       // 单个日志文件最大大小（字节）
    fileLevel?: LogLevel;   // 文件日志级别
  };
}
```

---

## 迁移指南

### 从 console.log 迁移

#### ❌ 旧代码

```typescript
// 主进程
console.log('Application started');
console.warn('Warning message');
console.error('Error:', error);

// 渲染进程
console.log('Component mounted');
console.info('Data loaded', data);
```

#### ✅ 新代码

```typescript
import { getLogger } from 'shared/logger';

const logger = getLogger('MainProcess');
logger.info('Application started');
logger.warn('Warning message');
logger.error('Error:', error);

// 渲染进程
const logger = getLogger('ComponentName');
logger.info('Component mounted');
logger.info('Data loaded', data);
```

### 替换现有 console 语句

#### 自动化脚本

创建一个迁移脚本来批量替换：

```bash
# 查找所有 console.log
grep -r "console\.log" packages/ --include="*.ts" --include="*.tsx"

# 使用 sed 替换（谨慎使用，需要审查）
find packages/ -name "*.ts" -o -name "*.tsx" | xargs sed -i '' 's/console\.log(/logger.info(/g'
```

#### 手动替换清单

- [ ] `packages/electron/src/` - 主进程代码
- [ ] `packages/renderer/src/` - 渲染进程代码
- [ ] `packages/shared/src/` - 共享代码

---

## 主进程使用

### 在主进程中初始化

```typescript
// packages/electron/src/index.ts
import { initLogger, configureLogger, LogLevel } from 'shared/logger';
import { getConfig } from './config/env';

app.whenReady().then(() => {
  const config = getConfig();

  // 根据环境配置日志
  configureLogger({
    level: config.LOG_LEVEL as LogLevel,
    format: config.NODE_ENV === 'development',
  });

  initLogger();
});
```

### 在 IPC Handler 中使用

```typescript
// packages/electron/src/ipc-server/handlers/DataSourceHandler.ts
import { getLogger } from 'shared/logger';

const logger = getLogger('DataSourceHandler');

class DataSourceHandler {
  async list(event, path: string) {
    logger.debug('Listing directory', { path });

    try {
      const files = await dataSource.list(path);
      logger.info('Directory listed', { count: files.length });
      return files;
    } catch (error) {
      logger.error('Failed to list directory', error, { path });
      throw error;
    }
  }
}
```

---

## 渲染进程使用

### 在组件中使用

```typescript
// packages/renderer/src/components/MyComponent.tsx
import { useEffect } from 'react';
import { getLogger } from 'shared/logger';

const logger = getLogger('MyComponent');

export const MyComponent = () => {
  useEffect(() => {
    logger.info('Component mounted');

    return () => {
      logger.info('Component unmounted');
    };
  }, []);

  const handleClick = () => {
    logger.debug('Button clicked');
    // 处理点击...
  };

  return <button onClick={handleClick}>Click me</button>;
};
```

### 在 MobX Store 中使用

```typescript
// packages/renderer/src/main/stores/UserStore.ts
import { makeAutoObservable } from 'mobx';
import { getLogger } from 'shared/logger';

const logger = getLogger('UserStore');

class UserStore {
  users: User[] = [];

  constructor() {
    makeAutoObservable(this);
    logger.info('UserStore initialized');
  }

  async loadUsers() {
    logger.debug('Loading users...');

    try {
      const data = await api.getUsers();
      runInAction(() => {
        this.users = data;
      });
      logger.info('Users loaded', { count: data.length });
    } catch (error) {
      logger.error('Failed to load users', error);
      throw error;
    }
  }
}
```

---

## 最佳实践

### 1. 合理使用日志级别

```typescript
// ✅ 好的实践
logger.debug('Processing file', { filename, size }); // 调试信息
logger.info('File processed successfully');           // 关键流程
logger.warn('File size exceeds recommended limit');  // 可恢复的问题
logger.error('File processing failed', error);       // 错误和异常

// ❌ 避免使用
logger.debug('User clicked button');  // 应该是更高级别
logger.info('x =', x);                // 应该是 debug
logger.error('Warning message');      // 应该是 warn
```

### 2. 包含上下文信息

```typescript
// ✅ 好的实践 - 包含上下文
logger.info('User logged in', {
  userId: user.id,
  username: user.name,
  ip: req.ip,
});

// ❌ 避免 - 缺少上下文
logger.info('User logged in');
```

### 3. 不记录敏感信息

```typescript
// ✅ 好的实践
logger.info('User login attempt', { username });
logger.info('API call', { endpoint: '/users' });

// ❌ 避免 - 记录敏感信息
logger.info('User login', { password: 'secret123' });
logger.info('API key', apiKey);
```

### 4. 使用结构化日志

```typescript
// ✅ 好的实践 - 结构化数据
logger.info('Configuration loaded', {
  theme: config.theme,
  language: config.language,
  features: config.features.length,
});

// ❌ 避免 - 字符串拼接
logger.info('Configuration loaded: ' + JSON.stringify(config));
```

---

## 日志文件

### 日志文件位置

- **Windows**: `%USERPROFILE%\AppData\Roaming\onote\logs\onote.log`
- **macOS**: `~/Library/Logs/onote/onote.log`
- **Linux**: `~/.config/onote/logs/onote.log`

### 日志轮转

日志文件会自动轮转，单个文件最大 10MB（默认配置）。

---

## 故障排查

### 问题：日志不显示

**可能原因：**
1. 日志级别设置过高
2. 格式化被禁用
3. 路径配置错误

**解决方案：**
```typescript
// 检查日志级别
import { configureLogger, LogLevel } from 'shared/logger';
configureLogger({ level: LogLevel.DEBUG });

// 确保格式化开启
configureLogger({ format: true });
```

### 问题：日志文件不创建

**可能原因：**
1. 日志路径无写入权限
2. fileLevel 设置过高

**解决方案：**
```typescript
import { configureLogger, LogLevel } from 'shared/logger';

configureLogger({
  fileOptions: {
    logPath: '/path/to/writable/directory/app.log',
    fileLevel: LogLevel.DEBUG,  // 降低文件日志级别
  },
});
```

---

## 示例项目

### 完整示例

```typescript
// packages/electron/src/main.ts
import { initLogger, configureLogger, LogLevel, getLogger } from 'shared/logger';
import { getConfig } from './config/env';

async function main() {
  // 初始化日志系统
  const config = getConfig();
  configureLogger({
    level: config.LOG_LEVEL as LogLevel,
    format: config.NODE_ENV === 'development',
    fileOptions: {
      logPath: '/path/to/logs/app.log',
      maxSize: 10 * 1024 * 1024,
    },
  });
  initLogger();

  const logger = getLogger('Main');
  logger.info('Application starting...');

  try {
    await startServer();
    logger.info('Server started successfully');
  } catch (error) {
    logger.error('Failed to start server', error);
    process.exit(1);
  }
}

main();
```

---

## 相关资源

- [electron-log 文档](https://github.com/megahertz/electron-log)
- [Electron 安全最佳实践](https://www.electronjs.org/docs/tutorial/security)
- [代码规范](./代码规范.md)

---

**版本**: 1.0
**最后更新**: 2025-01-04
