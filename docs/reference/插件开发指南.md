# ONote 插件开发指南

## 目录

- [插件系统简介](#插件系统简介)
- [插件结构](#插件结构)
- [开发环境准备](#开发环境准备)
- [创建第一个插件](#创建第一个插件)
- [插件 API](#插件-api)
- [插件生命周期](#插件生命周期)
- [调试插件](#调试插件)
- [发布插件](#发布插件)
- [最佳实践](#最佳实践)

---

## 插件系统简介

### 什么是插件？

插件是扩展 ONote 功能的独立模块。通过插件，你可以：

- 添加新的编辑器功能
- 集成外部服务
- 自定义 UI 组件
- 添加新的文件类型支持
- 实现自动化任务

### 插件架构

ONote 使用模块化的插件系统，每个插件都是独立的 Node.js 模块。

```
ONote 主应用
    │
    ├─ 插件管理器 (PluginManager)
    │   │
    │   ├─ 插件 A (如：Markdown 增强)
    │   ├─ 插件 B (如：代码格式化)
    │   └─ 插件 C (如：云同步)
```

---

## 插件结构

### 基本结构

```
my-onote-plugin/
├── package.json       # 插件配置
├── index.ts           # 插件入口
├── src/              # 源代码
│   ├── handler/      # IPC 处理器
│   ├── components/   # UI 组件
│   └── utils/        # 工具函数
├── README.md         # 插件说明
└── assets/           # 静态资源
```

### package.json

```json
{
  "name": "my-onote-plugin",
  "version": "1.0.0",
  "description": "我的 ONote 插件",
  "main": "index.ts",
  "keywords": ["onote", "plugin"],
  "onote": {
    "id": "my-plugin",
    "displayName": "我的插件",
    "version": "1.0.0",
    "description": "插件功能描述",
    "author": "Your Name",
    "entry": "index.ts",
    "permissions": [
      "fs:read",
      "fs:write",
      "ipc:send"
    ]
  },
  "dependencies": {
    // 插件依赖
  }
}
```

---

## 开发环境准备

### 1. 创建插件目录

```bash
# 在 packages/electron/src/plugin/plugins/ 下创建
mkdir -p my-onote-plugin/src
cd my-onote-plugin
```

### 2. 初始化项目

```bash
# 创建 package.json
yarn init -y

# 或手动创建上面的 package.json
```

### 3. 配置 TypeScript

创建 `tsconfig.json`:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "moduleResolution": "node",
    "types": ["node"]
  },
  "include": ["**/*.ts"],
  "exclude": ["node_modules", "dist"]
}
```

---

## 创建第一个插件

### 示例：简单的问候插件

这个插件会在应用启动时显示问候消息。

#### 1. 创建插件入口

`index.ts`:

```typescript
import { PluginContext } from '../PluginManager';

export interface PluginConfig {
  greeting?: string;
  userName?: string;
}

export default class GreetingPlugin {
  private context: PluginContext;
  private config: PluginConfig;

  constructor(context: PluginContext, config: PluginConfig = {}) {
    this.context = context;
    this.config = {
      greeting: 'Hello',
      userName: 'User',
      ...config,
    };
  }

  /**
   * 插件激活时调用
   */
  async activate() {
    const { greeting, userName } = this.config;
    const message = `${greeting}, ${userName}! Welcome to ONote!`;

    // 显示通知
    this.context.logger.info(message);

    // 注册 IPC 处理器
    this.context.ipc.register('greet', this.handleGreet.bind(this));
  }

  /**
   * 插件停用时调用
   */
  async deactivate() {
    this.context.logger.info('Greeting plugin deactivated');
  }

  /**
   * 处理问候请求
   */
  private async handleGreet(name?: string) {
    const { greeting, userName } = this.config;
    const targetName = name || userName;
    return `${greeting}, ${targetName}!`;
  }
}
```

#### 2. 注册插件

在 `packages/electron/src/plugin/PluginManager.ts` 中注册：

```typescript
import GreetingPlugin from './plugins/my-onote-plugin';

export class PluginManager {
  async loadPlugin(pluginPath: string) {
    const plugin = await import(pluginPath);
    const instance = new plugin.default(this.context, pluginConfig);
    await instance.activate();
    this.plugins.set(instance.id, instance);
  }
}
```

---

## 插件 API

### PluginContext

插件上下文提供了一组 API 供插件与 ONote 交互。

```typescript
interface PluginContext {
  // 插件信息
  id: string;
  version: string;
  path: string;

  // 日志
  logger: {
    info(message: string): void;
    warn(message: string): void;
    error(message: string, error?: Error): void;
  };

  // IPC 通信
  ipc: {
    register(channel: string, handler: Function): void;
    send(channel: string, ...args: any[]): void;
    invoke(channel: string, ...args: any[]): Promise<any>;
  };

  // 数据源访问
  dataSource: {
    read(path: string): Promise<string>;
    write(path: string, content: string): Promise<void>;
    list(path: string): Promise<FileEntry[]>;
  };

  // 设置
  settings: {
    get(key: string): any;
    set(key: string, value: any): void;
  };

  // UI
  ui: {
    registerCommand(id: string, handler: Function): void;
    addMenuItem(menuItem: MenuItem): void;
    showNotification(message: string, type?: 'info' | 'warning' | 'error'): void;
  };
}
```

### 核心功能

#### 1. 日志记录

```typescript
export default class MyPlugin {
  async activate() {
    this.context.logger.info('Plugin activated');
    this.context.logger.warn('Warning message');
    this.context.logger.error('Error occurred', new Error('details'));
  }
}
```

#### 2. IPC 通信

注册 IPC 处理器：

```typescript
export default class MyPlugin {
  async activate() {
    // 注册处理器
    this.context.ipc.register('myMethod', this.myMethod.bind(this));
  }

  private async myMethod(param1: string, param2: number) {
    // 处理逻辑
    return { success: true, data: 'result' };
  }
}
```

渲染进程调用：

```typescript
const result = await window.api.invoke('myMethod', 'param', 123);
```

#### 3. 访问文件系统

```typescript
export default class MyPlugin {
  async readTemplate() {
    const content = await this.context.dataSource.read(
      '/path/to/template.md'
    );
    return content;
  }

  async saveNote(content: string) {
    await this.context.dataSource.write(
      '/notes/new-note.md',
      content
    );
  }
}
```

#### 4. 注册命令

```typescript
export default class MyPlugin {
  async activate() {
    this.context.ui.registerCommand('myPlugin.doSomething', async () => {
      this.context.logger.info('Command executed');
    });
  }
}
```

#### 5. 添加菜单项

```typescript
export default class MyPlugin {
  async activate() {
    this.context.ui.addMenuItem({
      label: '我的功能',
      click: () => {
        this.context.ui.showNotification('功能已执行');
      }
    });
  }
}
```

---

## 插件生命周期

### activate()

插件激活时调用，进行初始化。

```typescript
async activate() {
  // 1. 注册 IPC 处理器
  this.context.ipc.register('method', handler);

  // 2. 注册命令
  this.context.ui.registerCommand('id', handler);

  // 3. 加载配置
  const config = await this.loadConfig();

  // 4. 初始化资源
  this.context.logger.info('Plugin activated');
}
```

### deactivate()

插件停用时调用，进行清理。

```typescript
async deactivate() {
  // 1. 取消注册
  // 2. 保存状态
  // 3. 释放资源
  this.context.logger.info('Plugin deactivated');
}
```

---

## 调试插件

### 1. 添加日志

```typescript
export default class MyPlugin {
  async activate() {
    this.context.logger.info('Starting activation...');
    // ...
    this.context.logger.info('Activation complete');
  }
}
```

### 2. 使用 VS Code 调试

创建 `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Plugin",
      "type": "node",
      "request": "attach",
      "port": 9229,
      "skipFiles": ["<node_internals>/**"]
    }
  ]
}
```

### 3. 测试 IPC 调用

```typescript
// 在渲染进程中测试
const result = await window.api.invoke('myMethod', 'test');
console.log('Plugin result:', result);
```

---

## 发布插件

### 1. 准备发布

```bash
# 构建插件
yarn build

# 测试插件
yarn test
```

### 2. 发布到 npm

```bash
# 登录 npm
npm login

# 发布
npm publish
```

### 3. 发布到 GitHub Releases

```bash
# 创建发布包
tar -czf my-onote-plugin-v1.0.0.tar.gz dist/

# 上传到 GitHub Releases
```

---

## 最佳实践

### 1. 错误处理

```typescript
export default class MyPlugin {
  async activate() {
    try {
      await this.initialize();
    } catch (error) {
      this.context.logger.error('Failed to activate', error);
      throw error;
    }
  }
}
```

### 2. 配置管理

```typescript
export interface PluginConfig {
  enabled?: boolean;
  option1?: string;
  option2?: number;
}

const defaultConfig: PluginConfig = {
  enabled: true,
  option1: 'default',
  option2: 100,
};

export default class MyPlugin {
  private config: PluginConfig;

  constructor(context: PluginContext, config: PluginConfig = {}) {
    this.config = { ...defaultConfig, ...config };
  }
}
```

### 3. 资源清理

```typescript
export default class MyPlugin {
  private timers: NodeJS.Timeout[] = [];

  async activate() {
    const timer = setInterval(() => {
      // 定时任务
    }, 1000);
    this.timers.push(timer);
  }

  async deactivate() {
    // 清理定时器
    this.timers.forEach(timer => clearInterval(timer));
    this.timers = [];
  }
}
```

### 4. 性能优化

```typescript
export default class MyPlugin {
  private cache: Map<string, any> = new Map();

  async getData(key: string) {
    // 检查缓存
    if (this.cache.has(key)) {
      return this.cache.get(key);
    }

    // 加载数据
    const data = await this.loadData(key);
    this.cache.set(key, data);
    return data;
  }
}
```

### 5. 文档和示例

```typescript
/**
 * 我的插件
 *
 * @example
 * ```typescript
 * const plugin = new MyPlugin(context, {
 *   option1: 'value'
 * });
 * await plugin.activate();
 * ```
 */
export default class MyPlugin {
  // ...
}
```

---

## 完整示例

### 统计字数插件

```typescript
import { PluginContext } from '../PluginManager';

export interface WordCountConfig {
  showInStatusBar?: boolean;
  updateInterval?: number;
}

export default class WordCountPlugin {
  private context: PluginContext;
  private config: WordCountConfig;
  private intervalId?: NodeJS.Timeout;

  constructor(context: PluginContext, config: WordCountConfig = {}) {
    this.context = context;
    this.config = {
      showInStatusBar: true,
      updateInterval: 1000,
      ...config,
    };
  }

  async activate() {
    this.context.logger.info('Word count plugin activating...');

    // 注册 IPC 处理器
    this.context.ipc.register('wordcount.count', this.countWords.bind(this));

    // 注册命令
    this.context.ui.registerCommand('wordcount.show', async () => {
      const count = await this.getCurrentWordCount();
      this.context.ui.showNotification(`Current word count: ${count}`);
    });

    this.context.logger.info('Word count plugin activated');
  }

  async deactivate() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
    }
    this.context.logger.info('Word count plugin deactivated');
  }

  private async countWords(filePath: string): Promise<number> {
    try {
      const content = await this.context.dataSource.read(filePath);
      const words = content.split(/\s+/).filter(word => word.length > 0);
      return words.length;
    } catch (error) {
      this.context.logger.error('Failed to count words', error as Error);
      return 0;
    }
  }

  private async getCurrentWordCount(): Promise<number> {
    // 获取当前打开的文件
    const currentFile = this.getCurrentFile();
    if (!currentFile) return 0;
    return this.countWords(currentFile);
  }

  private getCurrentFile(): string | null {
    // 实现获取当前文件的逻辑
    return null;
  }
}
```

---

## 相关资源

- [ONote 架构说明](./架构说明.md)
- [开发指南](./开发指南.md)
- [代码规范](./代码规范.md)
- [API 文档](./API.md)

---

## 获取帮助

- 查看 [GitHub Issues](https://github.com/your-org/ONote/issues)
- 提交新的 Issue
- 加入社区讨论

---

最后更新：2025-01-04
