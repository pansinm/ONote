# ONote 常见问题

本文档收集了开发和使用 ONote 过程中的常见问题及解决方案。

## 目录

- [安装与配置](#安装与配置)
- [开发问题](#开发问题)
- [构建与打包](#构建与打包)
- [Electron 相关](#electron-相关)
- [React 相关](#react-相关)
- [MobX 相关](#mobx-相关)
- [性能问题](#性能问题)
- [其他问题](#其他问题)

---

## 安装与配置

### Q: 依赖安装失败怎么办？

**症状：** `yarn install` 时出现错误

**可能原因和解决方案：**

1. **网络问题**
   ```bash
   # 使用国内镜像
   yarn config set registry https://registry.npmmirror.com
   yarn install
   ```

2. **Node.js 版本不匹配**
   ```bash
   # 检查版本
   node --version  # 应该是 18.x 或更高

   # 如果版本过低，升级 Node.js
   # 访问 https://nodejs.org/ 下载最新版本
   ```

3. **缓存问题**
   ```bash
   # 清理 Yarn 缓存
   yarn cache clean

   # 删除 node_modules
   rm -rf node_modules packages/*/node_modules

   # 重新安装
   yarn install
   ```

### Q: 为什么需要特定版本的 Node.js？

**A:** ONote 使用了一些较新的 JavaScript 特性和依赖包，需要 Node.js 18.x 或更高版本才能正常运行。

### Q: 如何在不同平台间同步开发环境？

**A:** 建议使用 Docker 容器化开发环境，或者确保所有平台使用相同版本的 Node.js 和依赖。

---

## 开发问题

### Q: 热更新不工作怎么办？

**症状：** 修改代码后应用没有自动更新

**解决方案：**

1. **确认开发模式已启动**
   ```bash
   # 使用正确命令启动
   yarn dev  # 而不是 yarn build
   ```

2. **检查 Webpack 配置**
   - 查看 `packages/renderer/webpack.config.js`
   - 确认 HMR (Hot Module Replacement) 已启用

3. **手动刷新**
   - Windows/Linux: `Ctrl + R`
   - macOS: `Cmd + R`

4. **重启开发服务器**
   ```bash
   # 停止当前服务器 (Ctrl+C)
   # 重新启动
   yarn dev
   ```

### Q: TypeScript 编译错误

**症状：** 编辑器显示红色波浪线或终端报错

**常见类型：**

1. **找不到模块**
   ```typescript
   // ❌ 错误
   import { Component } from './Component';

   // ✅ 正确 - 使用路径别名
   import { Component } from '/@/components/Component';
   ```

2. **类型不匹配**
   ```typescript
   // 确保类型定义正确
   interface Props {
     title: string;
     onClick: () => void;
   }
   ```

3. **解决方案**
   ```bash
   # 重新构建类型
   yarn build

   # 重启 TypeScript 服务器 (VS Code)
   # Cmd+Shift+P -> "TypeScript: Restart TS Server"
   ```

### Q: 如何调试渲染进程？

**A:**

1. **打开 DevTools**
   - 开发模式自动打开
   - 或按 `F12` / `Ctrl+Shift+I` / `Cmd+Option+I`

2. **使用 Chrome DevTools**
   - Console: 查看日志
   - Network: 监控请求
   - Performance: 性能分析
   - Memory: 内存分析

3. **使用 React Developer Tools**
   - 安装浏览器扩展
   - 开发模式自动加载
   - 查看组件树和状态

### Q: 如何调试主进程？

**A:**

1. **使用 VS Code 调试**

   创建 `.vscode/launch.json`:
   ```json
   {
     "version": "0.2.0",
     "configurations": [
       {
         "name": "Debug Main Process",
         "type": "node",
         "request": "launch",
         "cwd": "${workspaceFolder}",
         "runtimeExecutable": "${workspaceFolder}/node_modules/.bin/electron",
         "windows": {
           "runtimeExecutable": "${workspaceFolder}/node_modules/.bin/electron.cmd"
         },
         "args": ["."],
         "outputCapture": "std"
       }
     ]
   }
   ```

2. **添加 console.log**
   ```typescript
   // packages/electron/src/index.ts
   console.log('Debug info:', data);
   ```

3. **查看终端输出**
   - 主进程的 console.log 会显示在终端

---

## 构建与打包

### Q: 构建时出现内存溢出错误

**症状：** `CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory`

**解决方案：**

```bash
# 增加 Node.js 内存限制
export NODE_OPTIONS="--max-old-space-size=4096"
yarn build

# Windows
set NODE_OPTIONS=--max-old-space-size=4096
yarn build
```

### Q: 打包后应用无法启动

**可能原因和解决方案：**

1. **缺少文件**
   ```bash
   # 确认所有文件都包含在构建中
   # 检查 electron-builder.json 配置
   ```

2. **路径问题**
   ```typescript
   // 使用 __dirname 而不是相对路径
   const filePath = path.join(__dirname, 'assets', 'file.txt');
   ```

3. **查看日志**
   ```bash
   # macOS
   ~/Library/Logs/onote/

   # Windows
   %APPDATA%\onote\logs\

   # Linux
   ~/.config/onote/logs/
   ```

### Q: 如何减小应用体积？

**建议：**

1. **分析打包体积**
   ```bash
   yarn build:analyze
   ```

2. **移除未使用的依赖**
   ```bash
   # 查找未使用的包
   yarn depcheck
   ```

3. **启用生产优化**
   ```javascript
   // webpack.config.js
   mode: 'production',
   optimization: {
     minimize: true,
     // ...
   }
   ```

4. **使用 Tree Shaking**
   ```typescript
   // ✅ 使用具名导入
   import { Button } from '@fluentui/react-components';

   // ❌ 避免导入整个库
   import * as FluentUI from '@fluentui/react-components';
   ```

---

## Electron 相关

### Q: 主进程和渲染进程的区别？

**A:**

| 特性 | 主进程 | 渲染进程 |
|------|--------|----------|
| 数量 | 每个应用一个 | 每个窗口一个 |
| 环境 | Node.js | Chromium |
| 访问 DOM | ❌ | ✅ |
| 访问文件系统 | ✅ | ❌ (通过 IPC) |
| 职责 | 窗口管理、系统操作 | UI 渲染、用户交互 |

### Q: IPC 调用超时怎么办？

**症状：** `window.api.invoke()` 一直等待

**排查步骤：**

1. **检查命名空间和方法名**
   ```typescript
   // 确保拼写正确
   window.api.invoke('DataSource.list', path);
   ```

2. **确认 Handler 已注册**
   ```typescript
   // packages/electron/src/ipc-server/index.ts
   ipcServer.register(IPCNamespaces.DataSource, DataSourceHandler);
   ```

3. **添加日志**
   ```typescript
   // 主进程
   async method(event, param) {
     console.log('Called with:', param);
     return result;
   }

   // 渲染进程
   console.log('Calling...');
   const result = await window.api.invoke('method');
   console.log('Result:', result);
   ```

4. **检查主进程是否崩溃**
   - 查看终端是否有错误
   - 确认没有未捕获的异常

### Q: 如何实现跨窗口通信？

**A:** 使用 `webContents.send` 通过主进程中转：

```typescript
// 主进程
ipcMain.on('send-to-other-window', (event, data) => {
  const otherWindow = WindowManager.get('preview');
  otherWindow.webContents.send('message-from-main', data);
});

// 渲染进程 1
window.api.send('send-to-other-window', data);

// 渲染进程 2
window.api.on('message-from-main', (data) => {
  console.log('Received:', data);
});
```

---

## React 相关

### Q: 组件不更新怎么办？

**可能原因和解决方案：**

1. **忘记使用 observer（MobX）**
   ```typescript
   // ❌ 错误
   const MyComponent = () => {
     const { store } = stores;
     return <div>{store.data}</div>;
   };

   // ✅ 正确
   const MyComponent = observer(() => {
     const { store } = stores;
     return <div>{store.data}</div>;
   });
   ```

2. **直接解构 observable**
   ```typescript
   // ❌ 错误 - 失去响应性
   const { data } = store;

   // ✅ 正确
   const data = store.data;
   ```

3. **Props 没有变化**
   ```typescript
   // 使用 React.memo 优化
   const MyComponent = React.memo(({ data }) => {
     return <div>{data}</div>;
   });
   ```

### Q: 如何避免无限循环渲染？

**症状：** 组件不断重新渲染

**原因和解决方案：**

1. **依赖项数组问题**
   ```typescript
   // ❌ 错误 - 缺少依赖或依赖项不正确
   useEffect(() => {
     fetchData();
   }, [data]); // data 不断变化导致无限循环

   // ✅ 正确
   useEffect(() => {
     fetchData();
   }, [userId]); // 只在 userId 变化时执行
   ```

2. **在渲染中更新状态**
   ```typescript
   // ❌ 错误
   useEffect(() => {
     setCount(count + 1);  // 导致无限循环
   }, [count]);

   // ✅ 正确 - 使用函数更新
   useEffect(() => {
     setCount(c => c + 1);
   }, []);
   ```

3. **使用 useMemo 和 useCallback**
   ```typescript
   // 缓存计算结果
   const sortedList = useMemo(() => {
     return list.sort();
   }, [list]);

   // 缓存函数
   const handleClick = useCallback(() => {
     // ...
   }, [dependency]);
   ```

---

## MobX 相关

### Q: MobX 状态不更新？

**症状：** 修改了 store 但组件没有重新渲染

**解决方案：**

1. **确认使用了 makeAutoObservable**
   ```typescript
   class MyStore {
     data = [];

     constructor() {
       makeAutoObservable(this);  // ✅ 必须调用
     }
   }
   ```

2. **在异步操作中使用 runInAction**
   ```typescript
   // ❌ 错误
   async loadData() {
     const data = await fetchData();
     this.data = data;  // 不会触发更新
   }

   // ✅ 正确
   async loadData() {
     const data = await fetchData();
     runInAction(() => {
       this.data = data;
     });
   }
   ```

3. **组件使用 observer**
   ```typescript
   // ✅ 必须使用 observer
   export default observer(MyComponent);
   ```

---

## 性能问题

### Q: 应用启动缓慢怎么办？

**优化建议：**

1. **延迟加载插件**
   ```typescript
   // 只在需要时加载插件
   app.whenReady()
     .then(() => restoreOrCreateWindow())
     .then(() => {
       // 延迟加载非关键插件
       setTimeout(() => pluginManager.loadAll(), 2000);
     });
   ```

2. **优化 Webpack 打包**
   ```javascript
   // webpack.config.js
   optimization: {
     splitChunks: {
       chunks: 'all',
     },
   }
   ```

3. **使用代码分割**
   ```typescript
   // 懒加载组件
   const HeavyComponent = React.lazy(() => import('./HeavyComponent'));
   ```

### Q: 大文件渲染卡顿？

**解决方案：**

1. **使用虚拟滚动**
   ```typescript
   import { FixedSizeList } from 'react-window';

   <FixedSizeList
     height={600}
     itemCount={1000}
     itemSize={35}
     width="100%"
   >
     {({ index, style }) => (
       <div style={style}>Item {index}</div>
     )}
   </FixedSizeList>
   ```

2. **优化 Markdown 预览**
   ```typescript
   // 使用 Web Worker 在后台渲染
   const renderMarkdown = (content) => {
     worker.postMessage({ type: 'render', content });
   };
   ```

3. **节流和防抖**
   ```typescript
   import { debounce } from 'lodash';

   const handleChange = debounce((value) => {
     // 处理输入
   }, 300);
   ```

### Q: 内存泄漏怎么排查？

**步骤：**

1. **使用 Chrome DevTools Memory**
   - 拍摄堆快照
   - 执行操作
   - 再次拍摄快照
   - 对比差异

2. **检查事件监听器**
   ```typescript
   // ✅ 确保清理监听器
   useEffect(() => {
     const handler = () => { /* ... */ };
     window.addEventListener('event', handler);

     return () => {
       window.removeEventListener('event', handler);
     };
   }, []);
   ```

3. **检查订阅**
   ```typescript
   // ✅ 确保取消订阅
   useEffect(() => {
     const subscription = observable.subscribe(data => {
       // ...
   });

     return () => {
       subscription.unsubscribe();
     };
   }, []);
   ```

---

## 其他问题

### Q: 如何修改应用图标？

**步骤：**

1. 准备图标文件（PNG: 512x512, ICO: 256x256）
2. 放置到 `buildResources/` 目录
3. 配置 `electron-builder.json`:
   ```json
   {
     "win": {
       "icon": "buildResources/icon.ico"
     },
     "mac": {
       "icon": "buildResources/icon.icns"
     }
   }
   ```

### Q: 如何实现自动更新？

**A:** 使用 `electron-updater`:

```typescript
// packages/electron/src/index.ts
import { autoUpdater } from 'electron-updater';

if (process.env.NODE_ENV === 'production') {
  autoUpdater.checkForUpdatesAndNotify();
}
```

配置更新服务器（需要搭建）。

### Q: 如何支持多语言？

**建议方案：**

1. **使用 i18next**
   ```bash
   yarn add i18next react-i18next
   ```

2. **创建语言文件**
   ```typescript
   // locales/zh-CN.json
   {
     "common": {
       "save": "保存",
       "cancel": "取消"
     }
   }

   // locales/en-US.json
   {
     "common": {
       "save": "Save",
       "cancel": "Cancel"
     }
   }
   ```

3. **在组件中使用**
   ```typescript
   import { useTranslation } from 'react-i18next';

   const MyComponent = () => {
     const { t } = useTranslation();
     return <button>{t('common.save')}</button>;
   };
   ```

### Q: 如何联系获取帮助？

**渠道：**

- **GitHub Issues**: 报告 Bug
- **GitHub Discussions**: 技术讨论
- **Email**: your-email@example.com
- **文档**: 查看 [开发指南](./开发指南.md)

---

## 仍有问题？

如果以上没有解决你的问题：

1. 查看 [开发指南](./开发指南.md)
2. 查看 [架构说明](./架构说明.md)
3. 搜索 [GitHub Issues](https://github.com/your-org/ONote/issues)
4. 创建新的 Issue 并提供详细信息：
   - 操作系统版本
   - Node.js 版本
   - 错误信息
   - 复现步骤
   - 相关日志

我们会尽快回复！

---

最后更新：2025-01-04
