# Proposal: Add Line Numbers to LLM Context

## Summary

在文本内容传递给大模型之前，自动为每一行添加行号前缀，使大模型能够进行更精确的文本替换操作。

## Why

当前当用户与大模型讨论代码时，大模型无法直接感知和引用具体的行号位置。用户需要手动描述行号位置，大模型也难以准确理解要替换的文本范围。这导致：

1. 文本替换操作依赖用户手动提供行号
2. 大模型对代码位置的理解不精确
3. 用户需要额外的认知负担来描述代码位置

## What Changes

- 添加 `addLineNumbers` 工具函数
- 修改 `Agent.ts` 在消息构建时自动添加带行号的编辑器内容
- 编写单元测试确保函数正确性
- 更新 AGENTS.md 文档

## Problem Statement

当前当用户与大模型讨论代码时，大模型无法直接感知和引用具体的行号位置。用户需要手动描述行号位置，大模型也难以准确理解要替换的文本范围。这导致：

1. 文本替换操作依赖用户手动提供行号
2. 大模型对代码位置的理解不精确
3. 用户需要额外的认知负担来描述代码位置

## Proposed Solution

在文本传递给大模型之前，自动为每一行添加行号前缀，格式为 `1: content`。这样：

1. 大模型可以直接引用行号（如 "请修改第 5 行的函数名"）
2. 文本替换可以基于行号进行精确操作
3. 与现有的 `line_number` 和 `line_range` 替换模式形成更好的配合

## Scope

### In Scope

- 修改 `Store.ts` 中的文本内容处理逻辑
- 修改消息构建逻辑，自动添加行号
- 更新相关文档和测试

### Out of Scope

- 修改大模型 API 本身
- 修改现有的替换模式实现
- 修改编辑器显示的行号功能（这是 Monaco 的内置功能）

## Dependencies

- 现有 `AgentFileHandler.ts` 中的 `line_number` 和 `line_range` 替换模式
- 现有消息传递架构

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| 行号可能干扰大模型理解代码语义 | 中 | 行号作为纯数字前缀，不影响代码解析 |
| 消息长度增加， token 消耗增加 | 低 | 行号占用的 token 极少（2-3 字符/行） |
| 与现有功能冲突 | 低 | 仅在发送给大模型时添加，编辑器本身不变 |

## Success Criteria

1. 大模型能够正确理解带行号的文本内容
2. 大模型可以引用具体行号进行文本替换
3. 与现有替换操作无缝集成
4. 不影响编辑器显示和用户交互

## Timeline

- **Phase 1**: 核心实现（Store 文本处理、消息构建）
- **Phase 2**: 集成测试和验证
- **Phase 3**: 文档更新

## Open Questions

1. 是否需要为所有类型的消息添加行号，还是仅特定场景？
2. 行号格式是否需要可配置？
3. 如何处理空行？
